{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Topics</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="container">
        <h2>The topics present in the board</h2>

        <form method="get" class="search-form">
            <input type="text" name="q" placeholder="Search topics..." value="{{ query }}">
            <button type="submit">Search</button>
        </form>

        {% for topic in topics %}
            <div class="topic-row" data-topic-id="{{ topic.id }}">
                <div class="content">
                    <strong>{{ topic.subject }}</strong>
                    <small class="date">{{ topic.last_updated|date:"M d, Y H:i" }}</small>
                    <div class="posts">
                        {% for post in topic.posts.all %}
                            <div class="post-card">
                                <small class="author">{{ post.created_by.username }}:</small>
                                {{ post.message }}
                            </div>
                        {% empty %}
                            <div class="post-card">No posts yet.</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="votes">
                    <button class="vote-btn upvote">&#9650;</button>
                    <span class="vote-count">{{ topic.vote_count }}</span>
                    <button class="vote-btn downvote">&#9660;</button>
                </div>
            </div>
        {% empty %}
            <div class="no-data">No topics yet.</div>
        {% endfor %}
    </div>

    <script>
        document.querySelectorAll('.topic-row').forEach(function(row) {
            const upBtn = row.querySelector('.upvote');
            const downBtn = row.querySelector('.downvote');
            const countSpan = row.querySelector('.vote-count');
            const topicId = row.dataset.topicId;

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                            cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function sendVote(action) {
                fetch('{% url "update_vote" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        topic_id: topicId,
                        action: action
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        countSpan.textContent = data.new_count;
                    } else {
                        alert('Vote failed: ' + data.error);
                    }
                })
                .catch(err => console.error("Vote error:", err));
            }

            upBtn.addEventListener('click', e => {
                e.preventDefault();
                sendVote('upvote');
            });

            downBtn.addEventListener('click', e => {
                e.preventDefault();
                sendVote('downvote');
            });
        });
    </script>
</body>
</html>
